---
name: "Action: Image Build (matrixed)"

on:
  workflow_call:
    inputs:
      imagesToBuild:
        description: |-
          Pass a json string with the images and channels to build. e.g.:
            [
              {
                "app": "sonarr",
                "channel": "main"
              },
              {
                "app": "sonarr",
                "channel": "develop"
              }
            ]
        required: false
        type: string
        default: ''

      pushImages:
        required: false
        default: 'false'
        type: string

      sendNotification:
        required: false
        default: 'false'
        type: string

jobs:
  log-images:
    name: Log Images
    runs-on: ubuntu-latest
    steps:
      - name: Log images to build
        run: |
          echo 'imagesToBuild=${{ inputs.imagesToBuild }}'
          echo 'pushImages=${{ inputs.pushImages }}'
          echo 'sendNotification=${{ inputs.sendNotification }}'


  build-and-test:
    name: Build Images
    # if: inputs.imagesToBuild != '' && inputs.imagesToBuild != '[]'
    needs:
      - log-images
    strategy:
      matrix:
        image: ["${{ fromJson(inputs.imagesToBuild) }}"]
      fail-fast: false
    uses:
      ./.github/workflows/action-image-build-matrixed.yaml
    with:
      app: ${{ matrix.image.app }}
      channel: ${{ matrix.image.channel }}
      pushImages: ${{ inputs.pushImages }}
      sendNotification: ${{ inputs.sendNotification }}

  # Summarize matrix https://github.community/t/status-check-for-a-matrix-jobs/127354/7
  build_success:
    name: Build matrix success
    runs-on: ubuntu-latest
    needs:
      - build-and-test
    if: ${{ always() }}
    steps:
      - name: Check build matrix status
        if: ${{ (inputs.imagesToBuild != '' && inputs.imagesToBuild != '[]') && (needs.build-and-test.result != 'success') }}
        run: exit 1
